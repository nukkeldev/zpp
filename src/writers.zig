// -- Imports -- //

const std = @import("std");
const tracy = @import("util/tracy.zig");
const IR = @import("ir.zig").IR;

// -- Writers -- //

pub const IRWriter = struct {
    formatFilename: *const fn (std.mem.Allocator, []const u8) std.mem.Allocator.Error![:0]const u8,
    formatFile: *const fn (IR, *std.Io.Writer) std.Io.Writer.Error!void,
    postProcessFile: ?*const fn (std.mem.Allocator, []const u8) anyerror!void = null,
    checkFile: ?*const fn (std.mem.Allocator, [:0]const u8, anytype) anyerror!bool = null,
};

pub const CppWrapper: IRWriter = .{
    .formatFilename = @import("writers/cpp.zig").formatFilename,
    .formatFile = @import("writers/cpp.zig").formatFile,
    .checkFile = @import("writers/cpp.zig").checkFile,
};

pub const ZigWrapper: IRWriter = .{
    .formatFilename = @import("writers/zig.zig").formatFilename,
    .formatFile = @import("writers/zig.zig").formatFile,
    .postProcessFile = @import("writers/zig.zig").postProcessFile,
    .checkFile = @import("writers/zig.zig").checkFile,
};

// -- Helpers -- //

pub const PREAMBLE = "// This file was auto-generated by github:nukkeldev/zpp; I wouldn't recommend editing it.";

pub fn writeToFile(
    allocator: std.mem.Allocator,
    ir: IR,
    ir_writer: IRWriter,
    filename: []const u8,
) !void {
    var fz = tracy.FnZone.init(@src(), "writers.writeToFile");
    defer fz.end();

    const formatted_filename = try ir_writer.formatFilename(allocator, filename);

    var file = try std.fs.cwd().createFile(formatted_filename, .{});
    var buffer: [32768]u8 = undefined;
    @memset(&buffer, 0);

    var io_writer = file.writer(&buffer);
    try ir_writer.formatFile(ir, &io_writer.interface);
    try io_writer.interface.flush();
    file.close();

    if (ir_writer.postProcessFile) |ppf| try ppf(allocator, formatted_filename);
}

pub fn checkFile(
    allocator: std.mem.Allocator,
    ir_writer: IRWriter,
    filename: []const u8,
    args: anytype,
) !void {
    var fz = tracy.FnZone.init(@src(), "writers.checkFile");
    defer fz.end();

    if (ir_writer.checkFile == null) {
        std.log.err("Nothing to check the file with for IRWriter!", .{});
        return;
    }

    const formatted_filename = try ir_writer.formatFilename(allocator, filename);

    const good = try ir_writer.checkFile.?(
        allocator,
        formatted_filename,
        args,
    );

    if (!good) {
        std.log.err("'{s}' failed checks!", .{formatted_filename});
    }
}
